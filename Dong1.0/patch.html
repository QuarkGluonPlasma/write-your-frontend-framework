<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>æ‰‹å†™ä½ çš„å‰ç«¯æ¡†æ¶</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="ä» 0 åˆ° 1 æ‰‹å†™å‰ç«¯æ¡†æ¶">
    
    <link rel="preload" href="/write-your-frontend-framework/assets/css/0.styles.99845249.css" as="style"><link rel="preload" href="/write-your-frontend-framework/assets/js/app.e227b7ed.js" as="script"><link rel="preload" href="/write-your-frontend-framework/assets/js/2.86b0fa4a.js" as="script"><link rel="preload" href="/write-your-frontend-framework/assets/js/8.4d34ccca.js" as="script"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/10.ebedd676.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/11.d4745243.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/12.ee02c685.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/3.c41f35f1.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/4.b7d0708f.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/5.9a5fc195.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/6.345e52dd.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/7.8d61f760.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/9.724cfc50.js">
    <link rel="stylesheet" href="/write-your-frontend-framework/assets/css/0.styles.99845249.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/write-your-frontend-framework/" class="home-link router-link-active"><!----> <span class="site-name">æ‰‹å†™ä½ çš„å‰ç«¯æ¡†æ¶</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/write-your-frontend-framework/me.html" class="nav-link">
  ğŸ™‹â€â™‚ï¸ ä¸€èµ·æˆé•¿
</a></div> <a href="https://github.com/QuarkGluonPlasma/write-your-frontend-framework" target="_blank" rel="noopener noreferrer" class="repo-link">
    ç‚¹äº®â­ä¸è¿·è·¯
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/write-your-frontend-framework/me.html" class="nav-link">
  ğŸ™‹â€â™‚ï¸ ä¸€èµ·æˆé•¿
</a></div> <a href="https://github.com/QuarkGluonPlasma/write-your-frontend-framework" target="_blank" rel="noopener noreferrer" class="repo-link">
    ç‚¹äº®â­ä¸è¿·è·¯
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Dong1.0</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/write-your-frontend-framework/dong1.0.html" class="sidebar-link">å¯¼è¯»</a></li><li><a href="/write-your-frontend-framework/Dong1.0/vdom-render.html" class="sidebar-link">å®ç° vdom æ¸²æŸ“å’Œ jsx ç¼–è¯‘</a></li><li><a href="/write-your-frontend-framework/Dong1.0/component.html" class="sidebar-link">å®ç°ç»„ä»¶</a></li><li><a href="/write-your-frontend-framework/Dong1.0/patch.html" aria-current="page" class="active sidebar-link">å®ç° patch</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/write-your-frontend-framework/Dong1.0/patch.html#æµ‹è¯•ä»£ç " class="sidebar-link">æµ‹è¯•ä»£ç </a></li><li class="sidebar-sub-header"><a href="/write-your-frontend-framework/Dong1.0/patch.html#å®ç°-patch" class="sidebar-link">å®ç° patch</a></li><li class="sidebar-sub-header"><a href="/write-your-frontend-framework/Dong1.0/patch.html#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>å‰é¢ä¸¤ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å®ç°äº† vdom çš„æ¸²æŸ“å’Œ jsx çš„ç¼–è¯‘ï¼Œå®ç°äº† function å’Œ class ç»„ä»¶ï¼Œè¿™ç¯‡æ¥å®ç° patch æ›´æ–°ã€‚</p> <p>èƒ½å¤Ÿåš vdom çš„æ¸²æŸ“å’Œæ›´æ–°ï¼Œæ”¯æŒç»„ä»¶ï¼ˆpropsã€stateï¼‰ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„å‰ç«¯æ¡†æ¶äº†ã€‚</p> <p>é¦–å…ˆï¼Œæˆ‘ä»¬å‡†å¤‡ä¸‹æµ‹è¯•ä»£ç ï¼š</p> <h2 id="æµ‹è¯•ä»£ç "><a href="#æµ‹è¯•ä»£ç " class="header-anchor">#</a> æµ‹è¯•ä»£ç </h2> <p>åœ¨ä¸ŠèŠ‚çš„åŸºç¡€ä¸Šåšä¸‹æ”¹é€ ï¼š</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2a5a87a245546289c33e7ac428cc338~tplv-k3u1fbpfcp-watermark.image?" alt=""></p> <p>æ·»åŠ ä¸€ä¸ªåˆ é™¤æŒ‰é’®ï¼Œä¸€ä¸ªè¾“å…¥æ¡†å’Œæ·»åŠ æŒ‰é’®ï¼Œå¹¶ä¸”è¿˜è¦æ·»åŠ ç›¸åº”çš„äº‹ä»¶ç›‘å¬å™¨ï¼š</p> <p>è¿™éƒ¨åˆ†ä»£ç å¤§å®¶ç»å¸¸å†™ï¼Œå°±ä¸è¿‡å¤šè§£é‡Šäº†ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Item</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>li className<span class="token operator">=</span><span class="token string">&quot;item&quot;</span> style<span class="token operator">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>style<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span>  <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;#&quot;</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>onRemoveItem<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token constant">X</span> <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">List</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">list</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'aaa'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'pink'</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'bbb'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'orange'</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'ccc'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'yellow'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">handleItemRemove</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">list</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> i <span class="token operator">!==</span> index<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">handleAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">list</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">,</span> 
                <span class="token punctuation">{</span>
                    <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ref<span class="token punctuation">.</span>value
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>ul className<span class="token operator">=</span><span class="token string">&quot;list&quot;</span><span class="token operator">&gt;</span>
                <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Item style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">background</span><span class="token operator">:</span> item<span class="token punctuation">.</span>color<span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>textColor<span class="token punctuation">}</span><span class="token punctuation">}</span> onRemoveItem<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleItemRemove</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Item<span class="token operator">&gt;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">ele</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> ele<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleAdd</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>add<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>List textColor<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'#000'</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å‰é¢æˆ‘ä»¬å·²ç»å®ç°äº†æ¸²æŸ“ï¼Œç°åœ¨è¦å®ç°æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯ setState ä¹‹åæ›´æ–°é¡µé¢çš„æµç¨‹ã€‚</p> <h2 id="å®ç°-patch"><a href="#å®ç°-patch" class="header-anchor">#</a> å®ç° patch</h2> <p>å…¶å®æœ€ç®€å•çš„æ›´æ–°å°±æ˜¯ setState çš„æ—¶å€™é‡æ–°æ¸²æŸ“ä¸€æ¬¡ï¼Œæ•´ä¸ªæ›¿æ¢æ‰ä¹‹å‰çš„ domï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">const</span> newDom <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>newDom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dom <span class="token operator">=</span> newDom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æµ‹è¯•ä¸‹ï¼š</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4312390816374ba0832e888f3ba563eb~tplv-k3u1fbpfcp-watermark.image?" alt=""></p> <p>æˆ‘ä»¬å®ç°äº†æ›´æ–°åŠŸèƒ½ï¼</p> <p>å¼€ä¸ªç©ç¬‘ã€‚å‰ç«¯æ¡†æ¶ä¸ä¼šç”¨è¿™æ ·çš„æ–¹å¼æ›´æ–°çš„ï¼Œå¤šäº†å¾ˆå¤šæ²¡å¿…è¦çš„ dom æ“ä½œï¼Œæ€§èƒ½å¤ªå·®ã€‚</p> <p>æ‰€ä»¥è¿˜æ˜¯è¦å®ç° patchï¼Œä¹Ÿå°±æ˜¯ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>patch åŠŸèƒ½æ˜¯æŠŠè¦æ¸²æŸ“çš„ vdom å’Œå·²æœ‰çš„ dom åšä¸‹ diffï¼Œåªæ›´æ–°éœ€è¦æ›´æ–°çš„ domï¼Œä¹Ÿå°±æ˜¯æŒ‰éœ€æ›´æ–°</strong>ã€‚</p> <p>æ˜¯å¦è¦èµ° patch é€»è¾‘ï¼Œè¿™é‡Œå¯ä»¥åŠ ä¸€ä¸ª shouldComponentUpdate æ¥æ§åˆ¶ï¼Œå¦‚æœ props å’Œ state
éƒ½æ²¡å˜å°±ä¸ç”¨ patch äº†ã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> nextProps <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">||</span> nextState <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>patch æ€ä¹ˆå®ç°å‘¢ï¼Ÿ</p> <p>æ¸²æŸ“çš„æ—¶å€™æˆ‘ä»¬æ˜¯é€’å½’ vdomï¼Œå¯¹å…ƒç´ ã€æ–‡æœ¬ã€ç»„ä»¶åˆ†åˆ«åšä¸åŒçš„å¤„ç†ï¼ŒåŒ…æ‹¬åˆ›å»ºèŠ‚ç‚¹å’Œè®¾ç½®å±æ€§ã€‚patch æ›´æ–°çš„æ—¶å€™ä¹Ÿæ˜¯åŒæ ·çš„é€’å½’ï¼Œä½†æ˜¯å¯¹å…ƒç´ ã€æ–‡æœ¬ã€ç»„ä»¶åšçš„å¤„ç†ä¸åŒï¼š</p> <h3 id="æ–‡æœ¬"><a href="#æ–‡æœ¬" class="header-anchor">#</a> æ–‡æœ¬</h3> <p>åˆ¤æ–­ dom èŠ‚ç‚¹æ˜¯æ–‡æœ¬çš„è¯ï¼Œè¦å†çœ‹ vdomï¼š</p> <ul><li>å¦‚æœ vdom ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œç›´æ¥æ›¿æ¢</li> <li>å¦‚æœ vdom ä¹Ÿæ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œé‚£å°±å¯¹æ¯”ä¸‹å†…å®¹ï¼Œå†…å®¹ä¸ä¸€æ ·å°±æ›¿æ¢</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>dom <span class="token keyword">instanceof</span> <span class="token class-name">Text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vdom <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span>vdom<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> dom<span class="token punctuation">.</span>textContent <span class="token operator">!=</span> vdom <span class="token operator">?</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span>vdom<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> dom<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡Œçš„ replace çš„å®ç°æ˜¯ç”¨ replaceChildï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> replace <span class="token operator">=</span> parent <span class="token operator">?</span> <span class="token parameter">el</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    parent<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> el<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=&gt;</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ç„¶åæ˜¯ç»„ä»¶çš„æ›´æ–°ï¼š</p> <h3 id="ç»„ä»¶"><a href="#ç»„ä»¶" class="header-anchor">#</a> ç»„ä»¶</h3> <p>å¦‚æœ vdom æ˜¯ç»„ä»¶çš„è¯ï¼Œå¯¹åº”çš„ dom å¯èƒ½æ˜¯åŒä¸€ä¸ªç»„ä»¶æ¸²æŸ“çš„ï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯ã€‚</p> <p>è¦åˆ¤æ–­ä¸‹ dom æ˜¯ä¸æ˜¯åŒä¸€ä¸ªç»„ä»¶æ¸²æŸ“å‡ºæ¥çš„ï¼Œä¸æ˜¯çš„è¯ï¼Œç›´æ¥æ›¿æ¢ï¼Œæ˜¯çš„è¯æ›´æ–°å­å…ƒç´ ï¼š</p> <p>æ€ä¹ˆçŸ¥é“ dom æ˜¯ä»€ä¹ˆç»„ä»¶æ¸²æŸ“å‡ºæ¥çš„å‘¢ï¼Ÿ</p> <p>æˆ‘ä»¬éœ€è¦åœ¨ render çš„æ—¶å€™åœ¨ dom ä¸ŠåŠ ä¸ªå±æ€§æ¥è®°å½•ï¼š</p> <p>æ”¹ä¸‹ render éƒ¨åˆ†çš„ä»£ç ï¼ŒåŠ ä¸Š instance å±æ€§ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>instance<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>__instance <span class="token operator">=</span> instance<span class="token punctuation">;</span>
</code></pre></div><p>ç„¶åæ›´æ–°çš„æ—¶å€™å°±å¯ä»¥å¯¹æ¯”ä¸‹ constructor æ˜¯å¦ä¸€æ ·ï¼Œå¦‚æœä¸€æ ·è¯´æ˜æ˜¯åŒä¸€ä¸ªç»„ä»¶ï¼Œé‚£ dom æ˜¯å·®ä¸å¤šçš„ï¼Œå† patch å­å…ƒç´ ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>dom<span class="token punctuation">.</span>__instance <span class="token operator">&amp;&amp;</span> dom<span class="token punctuation">.</span><span class="token class-name">__instance</span><span class="token punctuation">.</span>constructor <span class="token operator">==</span> vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom<span class="token punctuation">.</span>__instance<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">patch</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> dom<span class="token punctuation">.</span>__instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>å¦åˆ™ï¼Œä¸æ˜¯åŒä¸€ä¸ªç»„ä»¶çš„è¯ï¼Œé‚£å°±ç›´æ¥æ›¿æ¢äº†ï¼š</p> <p>class ç»„ä»¶çš„æ›¿æ¢ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>Component<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> componentDom <span class="token operator">=</span> <span class="token function">renderComponent</span><span class="token punctuation">(</span>vdom<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">{</span>
        parent<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>componentDom<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> componentDom<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> componentDom
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>function ç»„ä»¶çš„æ›¿æ¢ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Component<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">patch</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> vdom<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰€ä»¥ï¼Œç»„ä»¶æ›´æ–°é€»è¾‘å°±æ˜¯è¿™æ ·çš„ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">isComponentVdom</span><span class="token punctuation">(</span><span class="token parameter">vdom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> vdom<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isComponentVdom</span><span class="token punctuation">(</span>vdom<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> props <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> vdom<span class="token punctuation">.</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">children</span><span class="token operator">:</span> vdom<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dom<span class="token punctuation">.</span>__instance <span class="token operator">&amp;&amp;</span> dom<span class="token punctuation">.</span><span class="token class-name">__instance</span><span class="token punctuation">.</span>constructor <span class="token operator">==</span> vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dom<span class="token punctuation">.</span>__instance<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">patch</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> dom<span class="token punctuation">.</span>__instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Component<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> componentDom <span class="token operator">=</span> <span class="token function">renderComponent</span><span class="token punctuation">(</span>vdom<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">{</span>
            parent<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>componentDom<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> componentDom<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> componentDom
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Component<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">patch</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> vdom<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿˜æœ‰å…ƒç´ çš„æ›´æ–°ï¼š</p> <h3 id="å…ƒç´ "><a href="#å…ƒç´ " class="header-anchor">#</a> å…ƒç´ </h3> <p>å¦‚æœ dom æ˜¯å…ƒç´ çš„è¯ï¼Œè¦çœ‹ä¸‹æ˜¯å¦æ˜¯åŒä¸€ç±»å‹çš„ï¼š</p> <ul><li>ä¸åŒç±»å‹çš„å…ƒç´ ï¼Œç›´æ¥æ›¿æ¢</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>dom<span class="token punctuation">.</span>nodeName <span class="token operator">!==</span> vdom<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> vdom <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span>vdom<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><ul><li>åŒä¸€ç±»å‹çš„å…ƒç´ ï¼Œæ›´æ–°å­èŠ‚ç‚¹å’Œå±æ€§</li></ul> <p>æ›´æ–°å­èŠ‚ç‚¹æˆ‘ä»¬å¸Œæœ›èƒ½é‡ç”¨çš„å°±é‡ç”¨ï¼Œæ‰€ä»¥åœ¨ render çš„æ—¶å€™ç»™æ¯ä¸ªå…ƒç´ åŠ ä¸Šä¸€ä¸ªæ ‡è¯† keyï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>instance<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>__key <span class="token operator">=</span> vdom<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
</code></pre></div><p>æ›´æ–°çš„æ—¶å€™å¦‚æœæ‰¾åˆ° key å°±é‡ç”¨ï¼Œæ²¡æ‰¾åˆ°å°± render ä¸€ä¸ªæ–°çš„ã€‚</p> <p>é¦–å…ˆæˆ‘ä»¬æŠŠæ‰€æœ‰çš„å­èŠ‚ç‚¹çš„ dom æ”¾åˆ°ä¸€ä¸ªå¯¹è±¡é‡Œï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> oldDoms <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token operator">...</span>dom<span class="token punctuation">.</span>childNodes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> child<span class="token punctuation">.</span>__key <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__index_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> child<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>[].concat æ˜¯ä¸ºäº†æ‹å¹³æ•°ç»„ï¼Œå› ä¸ºæ•°ç»„çš„å…ƒç´ ä¹Ÿæ˜¯æ•°ç»„ã€‚</p> <p>é»˜è®¤ key è®¾ç½®ä¸º indexã€‚</p> <p>ç„¶åå¾ªç¯æ¸²æŸ“ vdom çš„ childrenï¼Œå¦‚æœæ‰¾åˆ°å¯¹åº”çš„ key å°±ç›´æ¥å¤ç”¨ï¼Œç„¶åç»§ç»­ patch å®ƒçš„å­å…ƒç´ ã€‚å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°± render ä¸€ä¸ªæ–°çš„ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token operator">...</span>vdom<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> child<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__index_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    dom<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">render</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>æŠŠæ–°çš„ dom ä» oldDoms é‡Œå»æ‰ã€‚å‰©ä¸‹çš„å°±æ˜¯ä¸å†éœ€è¦çš„ domï¼Œç›´æ¥åˆ æ‰å³å¯ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> oldDoms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åˆ æ‰ä¹‹å‰è¿˜å¯ä»¥æ‰§è¡Œä¸‹ç»„ä»¶çš„ willUnmount çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> oldDoms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>__instance<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> instance<span class="token punctuation">.</span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å­èŠ‚ç‚¹å¤„ç†å®Œäº†ï¼Œå†å¤„ç†ä¸‹å±æ€§ï¼š</p> <p>è¿™ä¸ªå°±æ˜¯æŠŠæ—§çš„å±æ€§åˆ æ‰ï¼Œè®¾ç½®æ–°çš„ props å³å¯ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> attr <span class="token keyword">of</span> dom<span class="token punctuation">.</span>attributes<span class="token punctuation">)</span> dom<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> prop <span class="token keyword">in</span> vdom<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token function">setAttribute</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> vdom<span class="token punctuation">.</span>props<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>setAttribute ä¹‹å‰æˆ‘ä»¬åªåšäº† styleã€event listener å’Œæ™®é€šå±æ€§çš„å¤„ç†ï¼Œè¿˜éœ€è¦å†å®Œå–„ä¸‹ï¼š</p> <p>æ¯æ¬¡ event listener éƒ½è¦ remove å† addï¼Œè¿™æ · render å¤šæ¬¡ä¹Ÿå§‹ç»ˆåªæœ‰ä¸€ä¸ªï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">isEventListenerAttr</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> value <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEventListenerAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> eventType <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    dom<span class="token punctuation">.</span>__handlers <span class="token operator">=</span> dom<span class="token punctuation">.</span>__handlers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    dom<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> dom<span class="token punctuation">.</span>__handlers<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    dom<span class="token punctuation">.</span>__handlers<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    dom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> dom<span class="token punctuation">.</span>__handlers<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æŠŠå„ç§äº‹ä»¶çš„ listener æ”¾åˆ° dom çš„ __handlers å±æ€§ä¸Šï¼Œæ¯æ¬¡åˆ æ‰ä¹‹å‰çš„ï¼Œæ¢æˆæ–°çš„ã€‚</p> <p>ç„¶åå†æ”¯æŒä¸‹ ref å±æ€§ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">isRefAttr</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> key <span class="token operator">===</span> <span class="token string">'ref'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isRefAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">value</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>ä¹Ÿå°±æ˜¯è¿™æ ·çš„åŠŸèƒ½ï¼š</p> <div class="language-html extra-class"><pre class="language-html"><code>&lt;input ref={(ele) =&gt; {this.ref = ele}}/&gt;
</code></pre></div><p>å†æ”¯æŒä¸‹ key çš„è®¾ç½®ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'key'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom<span class="token punctuation">.</span>__key <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>è¿˜æœ‰ä¸€äº›ç‰¹æ®Šå±æ€§çš„è®¾ç½®ï¼ŒåŒ…æ‹¬ checkedã€valueã€classNameï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'checked'</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token string">'value'</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token string">'className'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>å…¶ä½™çš„å°±éƒ½æ˜¯ setAttribute è®¾ç½®äº†ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">isPlainAttr</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> value <span class="token operator">!=</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">!=</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰€ä»¥ç°åœ¨çš„ setAttribute æ˜¯è¿™æ ·çš„ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">setAttribute</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEventListenerAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> eventType <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dom<span class="token punctuation">.</span>__handlers <span class="token operator">=</span> dom<span class="token punctuation">.</span>__handlers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        dom<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> dom<span class="token punctuation">.</span>__handlers<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dom<span class="token punctuation">.</span>__handlers<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
        dom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> dom<span class="token punctuation">.</span>__handlers<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'checked'</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token string">'value'</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token string">'className'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dom<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isRefAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">value</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStyleAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>dom<span class="token punctuation">.</span>style<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'key'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dom<span class="token punctuation">.</span>__key <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ–‡æœ¬ã€ç»„ä»¶ã€å…ƒç´ çš„æ›´æ–°é€»è¾‘éƒ½å†™å®Œäº†ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸‹å§ï¼š</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/da2542c57347461a8ea1e70b9185ae65~tplv-k3u1fbpfcp-watermark.image?" alt=""></p> <p>å¤§åŠŸå‘Šæˆï¼</p> <p>æˆ‘ä»¬å®ç°äº† patch çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯ç»†ç²’åº¦çš„æŒ‰éœ€æ›´æ–°ã€‚</p> <p>ä»£ç ä¸Šä¼ åˆ°äº† githubï¼š<a href="https://github.com/QuarkGluonPlasma/frontend-framework-exercize" target="_blank" rel="noopener noreferrer">https://github.com/QuarkGluonPlasma/frontend-framework-exercize<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>patch å’Œ render ä¸€æ ·ï¼Œä¹Ÿæ˜¯é€’å½’çš„å¤„ç†å…ƒç´ ã€ç»„ä»¶ã€æ–‡æœ¬ã€‚</p> <p>patch æ—¶è¦å¯¹æ¯”ä¸‹ dom ä¸­çš„å’Œè¦æ¸²æŸ“çš„ vdom çš„ä¸€äº›ä¿¡æ¯ï¼Œç„¶åå†³å®šæ¸²æŸ“æ–°çš„ domï¼Œè¿˜æ˜¯å¤ç”¨å·²æœ‰ domï¼Œæ‰€ä»¥ render çš„æ—¶å€™è¦åœ¨ dom ä¸Šè®°å½• instanceã€key ç­‰ä¿¡æ¯ã€‚</p> <p>å…ƒç´ çš„å­å…ƒç´ æ›´æ–°è¦æ”¯æŒ keyåšæ ‡è¯†ï¼Œè¿™æ ·å¯ä»¥å¤ç”¨ä¹‹å‰çš„å…ƒç´ ï¼Œå‡å°‘ dom çš„åˆ›å»ºã€‚å±æ€§è®¾ç½®çš„æ—¶å€™ event listener è¦æ¯æ¬¡åˆ æ‰å·²æœ‰çš„å†æ·»åŠ ä¸€ä¸ªæ–°çš„ï¼Œä¿è¯åªä¼šæœ‰ä¸€ä¸ªã€‚</p> <p>å®ç°äº† vdom çš„æ¸²æŸ“å’Œæ›´æ–°ï¼Œå®ç°äº†ç»„ä»¶å’Œç”Ÿå‘½å‘¨æœŸï¼Œè¿™å·²ç»æ˜¯ä¸€ä¸ªå®Œæ•´çš„å‰ç«¯æ¡†æ¶äº†ã€‚</p> <p>è¿™æ˜¯æˆ‘ä»¬å®ç°çš„å‰ç«¯æ¡†æ¶çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œå«åš Dong 1.0ã€‚</p> <p>ä½†æ˜¯ï¼Œç°åœ¨çš„å‰ç«¯æ¡†æ¶æ˜¯é€’å½’çš„ render å’Œ patch çš„ï¼Œå¦‚æœ vdom æ ‘å¤ªå¤§ï¼Œä¼šè®¡ç®—é‡å¾ˆå¤§ï¼Œæ€§èƒ½ä¸ä¼šå¾ˆå¥½ï¼Œåé¢çš„ Dong 2.0 æˆ‘ä»¬å†æŠŠ vdom æ”¹é€ æˆ fiberï¼Œç„¶åå®ç°ä¸‹ hooks çš„åŠŸèƒ½ã€‚</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/QuarkGluonPlasma/write-your-frontend-framework/edit/master/docs/Dong1.0/patch.md" target="_blank" rel="noopener noreferrer">ä¸ºè¯¥ç« èŠ‚çº é”™</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">1/24/2022, 2:44:57 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/write-your-frontend-framework/Dong1.0/component.html" class="prev">
        å®ç°ç»„ä»¶
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/write-your-frontend-framework/assets/js/app.e227b7ed.js" defer></script><script src="/write-your-frontend-framework/assets/js/2.86b0fa4a.js" defer></script><script src="/write-your-frontend-framework/assets/js/8.4d34ccca.js" defer></script>
  </body>
</html>
