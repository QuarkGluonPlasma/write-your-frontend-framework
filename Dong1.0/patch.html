<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>手写你的前端框架</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="从 0 到 1 手写前端框架">
    
    <link rel="preload" href="/write-your-frontend-framework/assets/css/0.styles.99845249.css" as="style"><link rel="preload" href="/write-your-frontend-framework/assets/js/app.e227b7ed.js" as="script"><link rel="preload" href="/write-your-frontend-framework/assets/js/2.86b0fa4a.js" as="script"><link rel="preload" href="/write-your-frontend-framework/assets/js/8.4d34ccca.js" as="script"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/10.ebedd676.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/11.d4745243.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/12.ee02c685.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/3.c41f35f1.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/4.b7d0708f.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/5.9a5fc195.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/6.345e52dd.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/7.8d61f760.js"><link rel="prefetch" href="/write-your-frontend-framework/assets/js/9.724cfc50.js">
    <link rel="stylesheet" href="/write-your-frontend-framework/assets/css/0.styles.99845249.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/write-your-frontend-framework/" class="home-link router-link-active"><!----> <span class="site-name">手写你的前端框架</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/write-your-frontend-framework/me.html" class="nav-link">
  🙋‍♂️ 一起成长
</a></div> <a href="https://github.com/QuarkGluonPlasma/write-your-frontend-framework" target="_blank" rel="noopener noreferrer" class="repo-link">
    点亮⭐不迷路
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/write-your-frontend-framework/me.html" class="nav-link">
  🙋‍♂️ 一起成长
</a></div> <a href="https://github.com/QuarkGluonPlasma/write-your-frontend-framework" target="_blank" rel="noopener noreferrer" class="repo-link">
    点亮⭐不迷路
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Dong1.0</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/write-your-frontend-framework/dong1.0.html" class="sidebar-link">导读</a></li><li><a href="/write-your-frontend-framework/Dong1.0/vdom-render.html" class="sidebar-link">实现 vdom 渲染和 jsx 编译</a></li><li><a href="/write-your-frontend-framework/Dong1.0/component.html" class="sidebar-link">实现组件</a></li><li><a href="/write-your-frontend-framework/Dong1.0/patch.html" aria-current="page" class="active sidebar-link">实现 patch</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/write-your-frontend-framework/Dong1.0/patch.html#测试代码" class="sidebar-link">测试代码</a></li><li class="sidebar-sub-header"><a href="/write-your-frontend-framework/Dong1.0/patch.html#实现-patch" class="sidebar-link">实现 patch</a></li><li class="sidebar-sub-header"><a href="/write-your-frontend-framework/Dong1.0/patch.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>前面两篇文章，我们实现了 vdom 的渲染和 jsx 的编译，实现了 function 和 class 组件，这篇来实现 patch 更新。</p> <p>能够做 vdom 的渲染和更新，支持组件（props、state），这就是一个比较完整的前端框架了。</p> <p>首先，我们准备下测试代码：</p> <h2 id="测试代码"><a href="#测试代码" class="header-anchor">#</a> 测试代码</h2> <p>在上节的基础上做下改造：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2a5a87a245546289c33e7ac428cc338~tplv-k3u1fbpfcp-watermark.image?" alt=""></p> <p>添加一个删除按钮，一个输入框和添加按钮，并且还要添加相应的事件监听器：</p> <p>这部分代码大家经常写，就不过多解释了：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Item</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>li className<span class="token operator">=</span><span class="token string">&quot;item&quot;</span> style<span class="token operator">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>style<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span>  <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;#&quot;</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>onRemoveItem<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token constant">X</span> <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">List</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">list</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'aaa'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'pink'</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'bbb'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'orange'</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'ccc'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'yellow'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">handleItemRemove</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">list</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> i <span class="token operator">!==</span> index<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">handleAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">list</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">,</span> 
                <span class="token punctuation">{</span>
                    <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ref<span class="token punctuation">.</span>value
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>ul className<span class="token operator">=</span><span class="token string">&quot;list&quot;</span><span class="token operator">&gt;</span>
                <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Item style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">background</span><span class="token operator">:</span> item<span class="token punctuation">.</span>color<span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>textColor<span class="token punctuation">}</span><span class="token punctuation">}</span> onRemoveItem<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleItemRemove</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Item<span class="token operator">&gt;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">ele</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> ele<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleAdd</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>add<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>List textColor<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'#000'</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>前面我们已经实现了渲染，现在要实现更新，也就是 setState 之后更新页面的流程。</p> <h2 id="实现-patch"><a href="#实现-patch" class="header-anchor">#</a> 实现 patch</h2> <p>其实最简单的更新就是 setState 的时候重新渲染一次，整个替换掉之前的 dom：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">const</span> newDom <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>newDom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dom <span class="token operator">=</span> newDom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>测试下：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4312390816374ba0832e888f3ba563eb~tplv-k3u1fbpfcp-watermark.image?" alt=""></p> <p>我们实现了更新功能！</p> <p>开个玩笑。前端框架不会用这样的方式更新的，多了很多没必要的 dom 操作，性能太差。</p> <p>所以还是要实现 patch，也就是：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>patch 功能是把要渲染的 vdom 和已有的 dom 做下 diff，只更新需要更新的 dom，也就是按需更新</strong>。</p> <p>是否要走 patch 逻辑，这里可以加一个 shouldComponentUpdate 来控制，如果 props 和 state
都没变就不用 patch 了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dom<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> nextProps <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">||</span> nextState <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>patch 怎么实现呢？</p> <p>渲染的时候我们是递归 vdom，对元素、文本、组件分别做不同的处理，包括创建节点和设置属性。patch 更新的时候也是同样的递归，但是对元素、文本、组件做的处理不同：</p> <h3 id="文本"><a href="#文本" class="header-anchor">#</a> 文本</h3> <p>判断 dom 节点是文本的话，要再看 vdom：</p> <ul><li>如果 vdom 不是文本节点，直接替换</li> <li>如果 vdom 也是文本节点，那就对比下内容，内容不一样就替换</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>dom <span class="token keyword">instanceof</span> <span class="token class-name">Text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vdom <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span>vdom<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> dom<span class="token punctuation">.</span>textContent <span class="token operator">!=</span> vdom <span class="token operator">?</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span>vdom<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> dom<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的 replace 的实现是用 replaceChild：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> replace <span class="token operator">=</span> parent <span class="token operator">?</span> <span class="token parameter">el</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    parent<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> el<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=&gt;</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后是组件的更新：</p> <h3 id="组件"><a href="#组件" class="header-anchor">#</a> 组件</h3> <p>如果 vdom 是组件的话，对应的 dom 可能是同一个组件渲染的，也可能不是。</p> <p>要判断下 dom 是不是同一个组件渲染出来的，不是的话，直接替换，是的话更新子元素：</p> <p>怎么知道 dom 是什么组件渲染出来的呢？</p> <p>我们需要在 render 的时候在 dom 上加个属性来记录：</p> <p>改下 render 部分的代码，加上 instance 属性：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>instance<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>__instance <span class="token operator">=</span> instance<span class="token punctuation">;</span>
</code></pre></div><p>然后更新的时候就可以对比下 constructor 是否一样，如果一样说明是同一个组件，那 dom 是差不多的，再 patch 子元素：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>dom<span class="token punctuation">.</span>__instance <span class="token operator">&amp;&amp;</span> dom<span class="token punctuation">.</span><span class="token class-name">__instance</span><span class="token punctuation">.</span>constructor <span class="token operator">==</span> vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom<span class="token punctuation">.</span>__instance<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">patch</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> dom<span class="token punctuation">.</span>__instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>否则，不是同一个组件的话，那就直接替换了：</p> <p>class 组件的替换：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>Component<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> componentDom <span class="token operator">=</span> <span class="token function">renderComponent</span><span class="token punctuation">(</span>vdom<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">{</span>
        parent<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>componentDom<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> componentDom<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> componentDom
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>function 组件的替换：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Component<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">patch</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> vdom<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以，组件更新逻辑就是这样的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">isComponentVdom</span><span class="token punctuation">(</span><span class="token parameter">vdom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> vdom<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isComponentVdom</span><span class="token punctuation">(</span>vdom<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> props <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> vdom<span class="token punctuation">.</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">children</span><span class="token operator">:</span> vdom<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dom<span class="token punctuation">.</span>__instance <span class="token operator">&amp;&amp;</span> dom<span class="token punctuation">.</span><span class="token class-name">__instance</span><span class="token punctuation">.</span>constructor <span class="token operator">==</span> vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dom<span class="token punctuation">.</span>__instance<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">patch</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> dom<span class="token punctuation">.</span>__instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Component<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> componentDom <span class="token operator">=</span> <span class="token function">renderComponent</span><span class="token punctuation">(</span>vdom<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">{</span>
            parent<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>componentDom<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> componentDom<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> componentDom
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Component<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">patch</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> vdom<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>还有元素的更新：</p> <h3 id="元素"><a href="#元素" class="header-anchor">#</a> 元素</h3> <p>如果 dom 是元素的话，要看下是否是同一类型的：</p> <ul><li>不同类型的元素，直接替换</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>dom<span class="token punctuation">.</span>nodeName <span class="token operator">!==</span> vdom<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> vdom <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">(</span>vdom<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><ul><li>同一类型的元素，更新子节点和属性</li></ul> <p>更新子节点我们希望能重用的就重用，所以在 render 的时候给每个元素加上一个标识 key：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>instance<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>__key <span class="token operator">=</span> vdom<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
</code></pre></div><p>更新的时候如果找到 key 就重用，没找到就 render 一个新的。</p> <p>首先我们把所有的子节点的 dom 放到一个对象里：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> oldDoms <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token operator">...</span>dom<span class="token punctuation">.</span>childNodes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> child<span class="token punctuation">.</span>__key <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__index_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> child<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>[].concat 是为了拍平数组，因为数组的元素也是数组。</p> <p>默认 key 设置为 index。</p> <p>然后循环渲染 vdom 的 children，如果找到对应的 key 就直接复用，然后继续 patch 它的子元素。如果没找到，就 render 一个新的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token operator">...</span>vdom<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> child<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__index_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    dom<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">render</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>把新的 dom 从 oldDoms 里去掉。剩下的就是不再需要的 dom，直接删掉即可：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> oldDoms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>删掉之前还可以执行下组件的 willUnmount 的生命周期函数：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> oldDoms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>__instance<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> instance<span class="token punctuation">.</span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    oldDoms<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>子节点处理完了，再处理下属性：</p> <p>这个就是把旧的属性删掉，设置新的 props 即可：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> attr <span class="token keyword">of</span> dom<span class="token punctuation">.</span>attributes<span class="token punctuation">)</span> dom<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> prop <span class="token keyword">in</span> vdom<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token function">setAttribute</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> vdom<span class="token punctuation">.</span>props<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>setAttribute 之前我们只做了 style、event listener 和普通属性的处理，还需要再完善下：</p> <p>每次 event listener 都要 remove 再 add，这样 render 多次也始终只有一个：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">isEventListenerAttr</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> value <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEventListenerAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> eventType <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    dom<span class="token punctuation">.</span>__handlers <span class="token operator">=</span> dom<span class="token punctuation">.</span>__handlers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    dom<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> dom<span class="token punctuation">.</span>__handlers<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    dom<span class="token punctuation">.</span>__handlers<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    dom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> dom<span class="token punctuation">.</span>__handlers<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>把各种事件的 listener 放到 dom 的 __handlers 属性上，每次删掉之前的，换成新的。</p> <p>然后再支持下 ref 属性：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">isRefAttr</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> key <span class="token operator">===</span> <span class="token string">'ref'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isRefAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">value</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>也就是这样的功能：</p> <div class="language-html extra-class"><pre class="language-html"><code>&lt;input ref={(ele) =&gt; {this.ref = ele}}/&gt;
</code></pre></div><p>再支持下 key 的设置：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'key'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom<span class="token punctuation">.</span>__key <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>还有一些特殊属性的设置，包括 checked、value、className：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'checked'</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token string">'value'</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token string">'className'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>其余的就都是 setAttribute 设置了：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">isPlainAttr</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> value <span class="token operator">!=</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">!=</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以现在的 setAttribute 是这样的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">setAttribute</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEventListenerAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> eventType <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dom<span class="token punctuation">.</span>__handlers <span class="token operator">=</span> dom<span class="token punctuation">.</span>__handlers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        dom<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> dom<span class="token punctuation">.</span>__handlers<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dom<span class="token punctuation">.</span>__handlers<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
        dom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> dom<span class="token punctuation">.</span>__handlers<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'checked'</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token string">'value'</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token string">'className'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dom<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isRefAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">value</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStyleAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>dom<span class="token punctuation">.</span>style<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'key'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dom<span class="token punctuation">.</span>__key <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainAttr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>文本、组件、元素的更新逻辑都写完了，我们来测试下吧：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/da2542c57347461a8ea1e70b9185ae65~tplv-k3u1fbpfcp-watermark.image?" alt=""></p> <p>大功告成！</p> <p>我们实现了 patch 的功能，也就是细粒度的按需更新。</p> <p>代码上传到了 github：<a href="https://github.com/QuarkGluonPlasma/frontend-framework-exercize" target="_blank" rel="noopener noreferrer">https://github.com/QuarkGluonPlasma/frontend-framework-exercize<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>patch 和 render 一样，也是递归的处理元素、组件、文本。</p> <p>patch 时要对比下 dom 中的和要渲染的 vdom 的一些信息，然后决定渲染新的 dom，还是复用已有 dom，所以 render 的时候要在 dom 上记录 instance、key 等信息。</p> <p>元素的子元素更新要支持 key做标识，这样可以复用之前的元素，减少 dom 的创建。属性设置的时候 event listener 要每次删掉已有的再添加一个新的，保证只会有一个。</p> <p>实现了 vdom 的渲染和更新，实现了组件和生命周期，这已经是一个完整的前端框架了。</p> <p>这是我们实现的前端框架的第一个版本，叫做 Dong 1.0。</p> <p>但是，现在的前端框架是递归的 render 和 patch 的，如果 vdom 树太大，会计算量很大，性能不会很好，后面的 Dong 2.0 我们再把 vdom 改造成 fiber，然后实现下 hooks 的功能。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/QuarkGluonPlasma/write-your-frontend-framework/edit/master/docs/Dong1.0/patch.md" target="_blank" rel="noopener noreferrer">为该章节纠错</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">1/24/2022, 2:44:57 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/write-your-frontend-framework/Dong1.0/component.html" class="prev">
        实现组件
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/write-your-frontend-framework/assets/js/app.e227b7ed.js" defer></script><script src="/write-your-frontend-framework/assets/js/2.86b0fa4a.js" defer></script><script src="/write-your-frontend-framework/assets/js/8.4d34ccca.js" defer></script>
  </body>
</html>
